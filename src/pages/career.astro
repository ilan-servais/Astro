---
import Layout from '@layouts/Layout.astro';
import TimelineExperience from '@components/TimelineExperience.astro';
import timelineData from '../data/timeline.json';
import BackToTop from '@components/ui/BackToTop.astro';

// Tri des expériences par année du plus récent au plus ancien
const sortedExperiences = [...timelineData.experiences].sort((a, b) => {
  const extractYear = (yearStr) => {
    if (typeof yearStr === 'string') {
      const match = yearStr.match(/^\d{4}/);
      return match ? parseInt(match[0]) : 0;
    }
    return yearStr;
  };
  
  return extractYear(b.year) - extractYear(a.year);
});

// Récupérer l'ID de l'URL hash côté serveur si possible
const initialId = Astro.url.hash ? Astro.url.hash.substring(1) : "1";
---

<Layout title="Ilan Servais | Career path">
  <main class="mx-auto max-w-4xl px-4">
    <div class="text-center py-8">
      <h1 class="font-monospace text-3xl text-orange mb-6">My Career Path</h1>
    </div>

    <div class="space-y-12 pb-20">
      {sortedExperiences.map((exp) => (
        <div 
          id={exp.id.toString()} 
          class={`card-container group relative ${exp.id.toString() === initialId ? 'active' : ''}`} 
          data-exp-id={exp.id}
        >
          <TimelineExperience 
            id={exp.id}
            year={exp.year}
            company={exp.company}
            title={exp.title}
            description={exp.description}
            iconPath={exp.iconPath}
            city={exp.city}
          />
        </div>
      ))}
    </div>
    
    <div class="fixed bottom-5 right-5 z-50">
      <BackToTop />
    </div>
  </main>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    let userInteracting = false;
    
    // Fonction d'activation des cartes améliorée
    function activateCard(id, scroll = false) {
      // Désactiver toutes les cartes
      document.querySelectorAll('.card-container').forEach(card => {
        card.classList.remove('active');
      });
      
      // Activer la carte cible
      const targetCard = document.getElementById(id);
      if (targetCard) {
        targetCard.classList.add('active');
        
        // Mettre à jour l'URL sans rechargement
        if (history.replaceState) {
          history.replaceState(null, null, `#${id}`);
        }
        
        // Défiler si nécessaire
        if (scroll) {
          userInteracting = true;
          
          // Positionnement spécifique selon l'ID
          if (id === '1') {
            window.scrollTo({ top: 0, behavior: 'smooth' });
          } else if (id === '14') {
            window.scrollTo({ 
              top: document.body.scrollHeight, 
              behavior: 'smooth'
            });
          } else {
            targetCard.scrollIntoView({
              behavior: 'smooth',
              block: 'center'
            });
          }
          
          setTimeout(() => { userInteracting = false; }, 1000);
        }
      }
    }
    
    // Activation initiale basée sur le hash
    setTimeout(() => {
      const hash = window.location.hash;
      if (hash) {
        activateCard(hash.substring(1), true);
      } else {
        activateCard('1', false);
      }
    }, 100);
    
    // Ajout d'une détection spécifique pour les extrémités de la page
    function checkExtremePositions() {
      if (userInteracting) return;

      // Détection pour la première carte
      if (window.scrollY < 100) {
        activateCard('1', false);
        return;
      }
      
      // Détection pour la dernière carte
      const nearBottom = (window.innerHeight + window.scrollY) >= document.body.offsetHeight - 150;
      if (nearBottom) {
        activateCard('14', false);
        return;
      }
    }
    
    // Observer de visibilité avec ajustement pour les cas extrêmes
    const observer = new IntersectionObserver(entries => {
      // Ne pas traiter pendant une interaction utilisateur
      if (userInteracting) return;
      
      // Vérifier d'abord les positions extrêmes
      checkExtremePositions();
      
      // Poursuivre le traitement normal pour les autres cartes
      const visibleEntries = entries.filter(entry => entry.isIntersecting);
      if (!visibleEntries.length) return;
      
      // Obtenir toutes les cartes et leurs positions
      const cards = Array.from(document.querySelectorAll('.card-container'));
      const cardPositions = cards.map(card => {
        const rect = card.getBoundingClientRect();
        const cardId = card.getAttribute('data-exp-id');
        
        // Score de visibilité plus élevé pour les cartes extrêmes
        let centerScore = 1 - Math.abs(0.5 - ((rect.top + rect.bottom) / 2 / window.innerHeight));
        
        // Bonus pour les cartes 1 et 14 pour faciliter leur activation
        if (cardId === '1' || cardId === '14') {
          centerScore *= 1.2; // Bonus de 20%
        }
        
        return { id: cardId, centerScore };
      });
      
      // Trier par score de visibilité
      cardPositions.sort((a, b) => b.centerScore - a.centerScore);
      
      // Activer la carte la plus visible si son score est suffisant
      if (cardPositions.length && cardPositions[0].centerScore > 0.25) {
        activateCard(cardPositions[0].id, false);
      }
    }, {
      // Marges plus larges pour mieux détecter en haut et en bas
      rootMargin: "-5% 0px -5% 0px",
      threshold: [0.1, 0.2, 0.3, 0.4, 0.5, 0.6]
    });
    
    // Observer toutes les cartes
    document.querySelectorAll('.card-container').forEach(card => {
      observer.observe(card);
    });
    
    // Ajouter un écouteur pour le défilement pour les positions extrêmes
    window.addEventListener('scroll', () => {
      if (!userInteracting) {
        checkExtremePositions();
      }
    }, { passive: true });
    
    // Gestion des boutons de partage
    document.addEventListener('click', e => {
      const shareButton = e.target.closest('.share-button');
      if (!shareButton) return;
      
      const id = shareButton.dataset.id;
      if (id) {
        userInteracting = true;
        
        // Copier le lien
        const url = `${window.location.origin}/career#${id}`;
        navigator.clipboard.writeText(url).then(() => {
          const notification = document.getElementById('copy-notification');
          if (notification) {
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 2000);
          }
        });
        
        setTimeout(() => { userInteracting = false; }, 500);
      }
    });
  });
</script>

<style>
  /* Styles simplifiés pour une animation plus fluide */
  .card-container {
    position: relative;
    scroll-margin: 80px;
    transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
  }
  
  /* Styles spécifiques pour la première et la dernière carte */
  .card-container[data-exp-id="1"] {
    scroll-margin-top: 120px;
  }
  
  .card-container[data-exp-id="14"] {
    scroll-margin-bottom: 120px;
  }
  
  .card-container.active {
    border-left: 4px solid #E06330;
    transform: scale(1.01);
    transform-origin: left center;
    box-shadow: 0 10px 20px rgba(0,0,0,0.08);
  }
  
  /* Reste des styles inchangé */
  .timeline-experience {
    transition: transform 0.3s ease;
    transform-origin: left center;
    width: 100%;
  }
  
  .timeline-experience > * {
    transform: translateZ(0);
    backface-visibility: hidden;
  }
  
  .copy-notification {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #333;
    color: white;
    padding: 10px 20px;
    border-radius: 4px;
    z-index: 1000;
    animation: fadeInOut 2s ease;
  }
  
  @keyframes fadeInOut {
    0% { opacity: 0; }
    20% { opacity: 1; }
    80% { opacity: 1; }
    100% { opacity: 0; }
  }
</style>
